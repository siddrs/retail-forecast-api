<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory Prediction</title>
  <style>
    *, *::after, *::before { box-sizing:border-box; margin:0; padding:0; }
    @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
    .Header{ display:flex; align-items:center; justify-content:center; background:#9900ff; font-family:"Bangers",system-ui; color:#fff; margin:.5rem; border-top-right-radius:2rem; border-top-left-radius:2rem; font-size:1.75rem; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; padding:.75rem 1rem; }
    .Header img{ margin:1rem; margin-right:1rem; border-radius:4rem; }
    .main{ display:flex; flex-direction:column; align-items:center; margin:2.5rem; font-family:Inter,system-ui; }
    .form{ display:flex; gap:2rem; align-items:flex-start; margin-bottom:1.5rem; }
    label{ display:flex; flex-direction:column; font-size:1.05rem; }
    select, input[type="date"]{ width:18rem; padding:.6rem .8rem; border-radius:.5rem; background:#ded6ee; border:1px solid #cfc3ea; font-size:1rem; color:#111; }
    button{ margin-top:1rem; height:3rem; width:20rem; font-size:1rem; border-radius:.5rem; background:#9900ff; color:#fff; border:0; cursor:pointer; }
    .out{ margin-top:1rem; width:90%; max-width:640px; text-align:center; }
    .ok{ background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; padding:12px; border-radius:8px; }
    .err{ background:#fff1f2; border:1px solid #fecaca; color:#991b1b; padding:12px; border-radius:8px; }
    .meme{ margin-top:1rem; padding:1rem; border-radius:.5rem; background:#ded6ee; color:purple; font-size:1rem; }
  </style>
</head>
<body>
  <div class="Header">
    <div class="Circle">
      <img src="{{ url_for('static', filename='finalicon.png') }}" width="70" height="70" alt="icon"/>
      <!-- <img src="./finalicon.png" width="70" height="70" alt="icon"/> -->
    </div>
    <h1>Inventory Prediction</h1>
  </div>

  <div class="main" id="app">
    <div class="form">
      <label>Product Category
        <select id="category" name="category">
          <option value="" selected>-- Select a category --</option>
          <option value="Clothing">Clothing</option>
          <option value="Electronics">Electronics</option>
          <option value="Beauty">Beauty</option>
        </select>
      </label>

      <label>Date
        <input id="date" name="date" type="date" />
      </label>

      <label style="display:flex;flex-direction:column;">
        Forecast type
        <div style="display:flex;gap:.5rem;align-items:center;margin-top:.3rem;">
          <label><input type="radio" name="mode" value="single" checked /> Single day</label>
          <label><input type="radio" name="mode" value="multi" /> Multi-day</label>
          <input id="nDays" type="number" min="2" max="365" placeholder="days" style="width:6rem;padding:.4rem .6rem;border-radius:.4rem;background:#fff;border:1px solid #ccc;margin-left:.5rem;" />
        </div>
      </label>
    </div>

  <div style="
      background:#eef2ff;
      border-left:5px solid #6366f1;
      border-radius:8px;
      padding:14px 16px;
      margin:14px 0;
      color:#1e1b4b;
      font-size:0.92rem;
      line-height:1.5;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      text-align: center;
      ">
      <p style="margin-bottom:6px;font-weight:600;">
        <b>NOTE</b>
      </p>
      <p style="margin-bottom:6px;">
        Please select a date between <b>1 Jan 2023</b> and <b>1 Jan 2024</b>.
      </p>
      <p style="margin:0;">
        The prediction window (<b>1 Jan 2023 â€“ 1 Jan 2024</b>) is fixed because the training dataset
        contains sales data only for that period.
        The <b>RandomForest</b> model learns temporal patterns (daily, weekly, monthly)
        and depends on historical sales to compute lag and rolling statistics.
        Predicting outside this range would require newer data that were not part of training.
      </p>
  </div>
    
    <button id="predictBtn">Get Prediction</button>

    <div id="outWrapper" class="out" aria-live="polite"></div>

    <div class="graph-box">
      <img src="{{ url_for('static', filename='graph.png') }}" 
         alt="Prediction v/s Actual graph"
        style="max-width:100%;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-top:1rem;">
    </div>
    
  </div>

  <script>
    // Use relative path so file can be served from same origin as Flask.
    const predictEndpoint = '/predict';

    const categoryEl = document.getElementById('category');
    const dateEl = document.getElementById('date');
    const out = document.getElementById('outWrapper');
    const btn = document.getElementById('predictBtn');

    function show(msg, type='ok') {
      out.innerHTML = '';
      const d = document.createElement('div');
      d.className = type === 'err' ? 'err' : 'ok';
      d.textContent = msg;
      out.appendChild(d);
    }

    async function requestPrediction(category, date) {
      const payload = { product_category: category, date: date };
      const resp = await fetch(predictEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const json = await resp.json().catch(() => ({}));
      return { ok: resp.ok, status: resp.status, body: json };
    }

    btn.addEventListener('click', async () => {
      const category = categoryEl.value.trim();
      const date = dateEl.value;
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const nDaysEl = document.getElementById('nDays');
      const nDays = mode === 'multi' ? parseInt(nDaysEl.value || "0", 10) : 1;

      if (!category) { show('Select a category.', 'err'); return; }
      if (!date) { show('Select a date.', 'err'); return; }
      if (mode === 'multi' && (!nDays || nDays < 2)) { show('Enter N days (>=2) for multi-day.', 'err'); return; }

      btn.disabled = true;
      show('Requesting prediction...');

      try {
        const payload = { product_category: category, date: date };
        if (nDays && nDays > 1) payload.n_days = nDays;

        const resp = await fetch(predictEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const json = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          const msg = (json && (json.error || json.message)) || `Server error ${resp.status}`;
          if (/out of range/i.test(msg)) {
            show('Date out of range.', 'err');
          } else {
            show(msg, 'err');
          }
        } else {
          const body = json || {};
          if (body.predictions && Array.isArray(body.predictions)) {
            // render list
            out.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'ok';
            const title = document.createElement('div');
            title.style.fontWeight = '600';
            title.style.marginBottom = '6px';
            title.textContent = `Predictions for ${body.product_category} from ${body.start_date} (${body.n_days} day(s))`;
            container.appendChild(title);

            const list = document.createElement('div');
            list.style.textAlign = 'left';
            list.style.maxHeight = '260px';
            list.style.overflow = 'auto';
            list.style.marginTop = '6px';
            body.predictions.forEach(p => {
              const row = document.createElement('div');
              row.textContent = `${p.date}: ${p.predicted_quantity}`;
              row.style.padding = '4px 0';
              list.appendChild(row);
            });
            container.appendChild(list);
            out.appendChild(container);
          } else if (body.predicted_quantity !== undefined) {
            show(`Predicted quantity: ${body.predicted_quantity}`, 'ok');
          } else {
            show('Unexpected response from server: ' + JSON.stringify(body), 'err');
          }
        }
      } catch (e) {
        show('Network error: ' + (e.message || e), 'err');
      } finally {
        btn.disabled = false;
      }
    });

  </script>
</body>
</html>
