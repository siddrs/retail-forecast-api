<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory Prediction</title>
  <style>
    *, *::after, *::before { box-sizing:border-box; margin:0; padding:0; }
    @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
    .Header{ display:flex; align-items:center; justify-content:center; background:#9900ff; font-family:"Bangers",system-ui; color:#fff; margin:.5rem; border-top-right-radius:2rem; border-top-left-radius:2rem; font-size:1.75rem; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; padding:.75rem 1rem; }
    .Header img{ margin:1rem; margin-right:1rem; border-radius:4rem; }
    .main{ display:flex; flex-direction:column; align-items:center; margin:2.5rem; font-family:Inter,system-ui; }
    .form{ display:flex; gap:2rem; align-items:flex-start; margin-bottom:1.5rem; }
    label{ display:flex; flex-direction:column; font-size:1.05rem; }
    select, input[type="date"]{ width:18rem; padding:.6rem .8rem; border-radius:.5rem; background:#ded6ee; border:1px solid #cfc3ea; font-size:1rem; color:#111; }
    button{ margin-top:1rem; height:3rem; width:20rem; font-size:1rem; border-radius:.5rem; background:#9900ff; color:#fff; border:0; cursor:pointer; }
    .out{ margin-top:1rem; width:90%; max-width:640px; text-align:center; }
    .ok{ background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; padding:12px; border-radius:8px; }
    .err{ background:#fff1f2; border:1px solid #fecaca; color:#991b1b; padding:12px; border-radius:8px; }
    .meme{ margin-top:1rem; padding:1rem; border-radius:.5rem; background:#ded6ee; color:purple; font-size:1rem; }
  </style>
</head>
<body>
  <div class="Header">
    <div class="Circle">
      <img src="{{ url_for('static', filename='finalicon.png') }}" width="70" height="70" alt="icon"/>
      <!-- <img src="./finalicon.png" width="70" height="70" alt="icon"/> -->
    </div>
    <h1>Inventory Prediction</h1>
  </div>

  <div class="main" id="app">
    <div class="form">
      <label>Product Category
        <select id="category" name="category">
          <option value="" selected>-- Select a category --</option>
          <option value="Clothing">Clothing</option>
          <option value="Electronics">Electronics</option>
          <option value="Beauty">Beauty</option>
        </select>
      </label>

      <label>Date
        <!-- remove hardcoded min/max so backend decides validity -->
        <input id="date" name="date" type="date" />
      </label>
    </div>

  <div style="
      background:#eef2ff;
      border-left:5px solid #6366f1;
      border-radius:8px;
      padding:14px 16px;
      margin:14px 0;
      color:#1e1b4b;
      font-size:0.92rem;
      line-height:1.5;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      text-align: center;
      ">
      <p style="margin-bottom:6px;font-weight:600;">
        <b>NOTE</b>
      </p>
      <p style="margin-bottom:6px;">
        Please select a date between <b>1 Jan 2023</b> and <b>1 Jan 2024</b>.
      </p>
      <p style="margin:0;">
        The prediction window (<b>1 Jan 2023 â€“ 1 Jan 2024</b>) is fixed because the training dataset
        contains sales data only for that period.
        The <b>RandomForest</b> model learns temporal patterns (daily, weekly, monthly)
        and depends on historical sales to compute lag and rolling statistics.
        Predicting outside this range would require newer data that were not part of training.
      </p>
  </div>
    
    <button id="predictBtn">Get Prediction</button>

    <div id="outWrapper" class="out" aria-live="polite"></div>

    <div class="graph-box">
      <img src="{{ url_for('static', filename='graph.png') }}" 
         alt="Prediction v/s Actual graph"
        style="max-width:100%;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-top:1rem;">
    </div>
    
  </div>

  <script>
    // Use relative path so file can be served from same origin as Flask.
    const predictEndpoint = '/predict';

    const categoryEl = document.getElementById('category');
    const dateEl = document.getElementById('date');
    const out = document.getElementById('outWrapper');
    const btn = document.getElementById('predictBtn');

    function show(msg, type='ok') {
      out.innerHTML = '';
      const d = document.createElement('div');
      d.className = type === 'err' ? 'err' : 'ok';
      d.textContent = msg;
      out.appendChild(d);
    }

    async function requestPrediction(category, date) {
      // POST JSON { product_category, date } as your Flask backend expects
      const payload = { product_category: category, date: date };
      const resp = await fetch(predictEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const json = await resp.json().catch(() => ({}));
      return { ok: resp.ok, status: resp.status, body: json };
    }

    btn.addEventListener('click', async () => {
      const category = categoryEl.value.trim();
      const date = dateEl.value;

      if (!category) { show('Select a category.', 'err'); return; }
      if (!date) { show('Select a date.', 'err'); return; }

      btn.disabled = true;
      show('Requesting prediction...');

      try {
        const res = await requestPrediction(category, date);

        if (!res.ok) {
          // Prefer server-provided error message. Many Flask APIs return { "error": "..." }.
          const msg = (res.body && (res.body.error || res.body.message)) || `Server error ${res.status}`;
          // Normalize common phrase.
          if (/out of range/i.test(msg)) {
            show('Date out of range.', 'err');
          } else {
            show(msg, 'err');
          }
        } else {
          // Success path. Expecting { predicted_quantity: <number> }.
          const body = res.body || {};
          if (body.predicted_quantity !== undefined) {
            show(`Predicted quantity: ${body.predicted_quantity}`, 'ok');
          } else {
            // If backend returns the valid range instead, report that.
            show('Unexpected response from server: ' + JSON.stringify(body), 'err');
          }
        }
      } catch (e) {
        show('Network error: ' + (e.message || e), 'err');
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
